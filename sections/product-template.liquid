<section class="py-3 py-md-5">
  <div class="container">
    <div class="row g-4">
      <!-- Image Column -->
      <div class="col-12 col-md-6">
        {% if product.featured_image %}
          <img
            src="{{ product.featured_image | image_url: width: 800 }}"
            alt="{{ product.title }}"
            class="img-fluid rounded"
            width="100%"
            height="auto"
            id="main-image"
          >
          {% if product.images.size > 1 %}
            <div class="thumbnail text-center mt-2 d-flex gap-2">
              {% for image in product.images %}
                <img onclick="change_image(this)" src="{{ image.src | img_url:'original' }}" width="100" height="auto">
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="bg-light rounded text-center py-5">No image available</div>
        {% endif %}
        <!-- .img-fluid ensures responsive images :contentReference[oaicite:3]{index=3} -->
      </div>

      <!-- Details Column -->
      <div class="col-12 col-md-6">
        <form
          method="post"
          action="/cart/add"
        >
          {% for block in section.blocks %}
            {% case block.type %}
              {% when 'product_title' %}
                <h1 class="h2 mb-3">{{ product.title }}</h1>
              {% when 'product_price' %}
                <h3 class="text-primary mb-3">
                  <span id="product_price">{{ product.selected_or_first_available_variant.price | money }}</span>
                </h3>
              {% when 'product_description' %}
                <p class="mb-4">{{ product.description }}</p>

                <!-- Variant Selector & Quantity -->

              {% when 'product_variant' %}
                {% unless product.has_only_default_variant %}
                  <div class="product-variants mt-5" id="product-variants">
                    {% for option in product.options_with_values %}
                      {% liquid
                        assign variants_available_arr = product.variants | map: 'available'
                        assign variants_option1_arr = product.variants | map: 'option1'
                        assign variants_option2_arr = product.variants | map: 'option2'
                        assign variants_option3_arr = product.variants | map: 'option3'
                      %}
                      <div class="option {{ option.name | downcase }} mt-3">
                        <h6 class="text-uppercase">{{ option.name }}</h6>
                        {% for value in option.values %}
                          {% liquid
                            assign option_disabled = true

                            for option1_name in variants_option1_arr
                              case option.position
                                when 1
                                  if variants_option1_arr[forloop.index0] == value and variants_available_arr[forloop.index0]
                                    assign option_disabled = false
                                  endif
                                when 2
                                  if option1_name == product.selected_or_first_available_variant.option1 and variants_option2_arr[forloop.index0] == value and variants_available_arr[forloop.index0]
                                    assign option_disabled = false
                                  endif
                                when 3
                                  if option1_name == product.selected_or_first_available_variant.option1 and variants_option2_arr[forloop.index0] == product.selected_or_first_available_variant.option2 and variants_option3_arr[forloop.index0] == value and variants_available_arr[forloop.index0]
                                    assign option_disabled = false
                                  endif
                              endcase
                            endfor
                          %}
                          <label class="radio">
                            <input
                              type="radio"
                              name="{{- option.name | handleize -}}"
                              value="{{- value | handleize | escape -}}"
                              {% if option.selected_value == value %}
                                checked
                              {% endif %}
                              {% if option_disabled %}
                                disabled
                              {% endif %}
                            >
                            <span
                              {% if option_disabled %}
                                title="unavailable"
                              {% endif %}
                            >
                              {{ value | escape }}
                            </span>
                          </label>
                        {% endfor %}
                      </div>
                    {% endfor %}
                  </div>
                  <select name="id" id="variant_selector" class="d-none">
                    {% for variant in product.variants %}
                      <option
                        value="{{ variant.id }}"
                        data-name="{{ variant.title | handleize | escape }}"
                        {%- if variant == current_variant %}
                          selected
                        {%- endif -%}
                        {%- if variant.available == false %}
                          data-sold="true"
                        {% endif %}
                      >
                        {{ variant.title | escape }}
                      </option>
                    {% endfor %}
                  </select>
                {% endunless %}

                <!-- Quantity input -->
              {% when 'product_quantity' %}
                <div class="w-full mt-3">
                  <label for="quantity">Select quantity</label>
                  <input
                    type="number"
                    name="quantity"
                    value="1"
                    min="1"
                    class="form-control w-auto mt-2"
                    id="quantity"
                  >
                </div>
              {% when 'product_add_to_cart' %}
                <!-- Add to Cart -->
                <button
                  type="submit"
                  class="vivewear_btn_primary mt-3"
                >
                  Add to Cart
                </button>

                <!-- Bootstrap form components styled & accessible :contentReference[oaicite:4]{index=4} -->
              {% when 'product_sku' %}
                <!-- Optional: SKU Info -->
                <div class=" text-muted mt-3    ">
                  {% if product.sku != null %}
                    <p>SKU: {{ product.sku -}}</p>
                  {% endif %}

                  <!-- example of pulling vendor via Liquid :contentReference[oaicite:5]{index=5} -->
                </div>
              {% when 'product_vendor' %}
                <!-- Optional: Vendor Info -->
                <div class=" text-muted mt-3    ">
                  {% if product.vendor != null %}
                    <p>Vendor: {{ product.vendor }}</p>
                  {% endif %}
                  <!-- example of pulling vendor via Liquid :contentReference[oaicite:5]{index=5} -->
                </div>
            {% endcase %}
          {% endfor %}
        </form>
      </div>
    </div>
  </div>
</section>
<!-- JavaScript for dynamic price update -->

<script>
    function change_image(image){
    var main_image = document.getElementById("main-image");
    main_image.src = image.src;
  }
  var productVariants = {
    {% for variant in product.variants %}
      "{{ variant.id }}": "{{ variant.price | money }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  };
</script>

{% comment %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var variantSelect = document.getElementById('variant-selector');
      var priceElement = document.getElementById('product_price');

      if (!variantSelect || !priceElement) return;

      // Update price on selector change
      variantSelect.addEventListener('change', function () {
        var selectedId = variantSelect.value;
        var newPrice = productVariants[selectedId];

        if (newPrice) {
          priceElement.textContent = newPrice;
        }
      });
    });
  </script>
{% endcomment %}

<script>
  window.addEventListener('DOMContentLoaded', async () => {
    const product_url = '{{ product.url }}';
    const variantSelector = async () => {
      const options = document.querySelectorAll('#product-variants .option');
      let option_value = [];
      options.forEach((elm) => {
        let selected = elm.querySelector('input:checked').value;
        option_value.push(selected);
      });
      option_value = option_value.join('-');
      //   console.log(option_value);

      const selOptions = document.querySelectorAll('#variant_selector option');
      selOptions.forEach((elm) => {
        const name = elm.dataset.name;
        const sold = elm.dataset.sold;
        elm.removeAttribute('selected');
        if (name == option_value) {
          const btn = document.querySelector('[name="add"]');
          if (sold) {
            btn.setAttribute('disabled', 'true');
            btn.innerText = 'Sold Out';
          } else {
            elm.setAttribute('selected', 'true');
            btn.removeAttribute('disabled');
            btn.innerText = 'Add To Cart';
          }
        }
      });
    };
    await variantSelector();
    const optionSelectors = document.querySelectorAll('#product-variants label.radio');
    optionSelectors.forEach((elm) => {
      elm.addEventListener('click', () => {
        variantSelector().then(() => {
          let variantId = document.querySelector('#variant_selector');
          variantId = variantId.value;
          let url = `${product_url}?variant=${variantId}`;
          window.history.replaceState({}, '', url);
        });
      });
    });
  });
</script>

{% schema %}
{
  "name": "single product",
  "settings": [],
  "blocks": [
    {
      "type": "product_title",
      "name": "Product title"
    },
    {
      "type": "product_description",
      "name": "Product description"
    },
    {
      "type": "product_price",
      "name": "Product price"
    },
    {
      "type": "product_variant",
      "name": "Product variant"
    },
    {
      "type": "product_quantity",
      "name": "Product quantity"
    },
    {
      "type": "product_add_to_cart",
      "name": "Product add to cart"
    },
    {
      "type": "product_sku",
      "name": "Product SKU"
    },
    {
      "type": "product_vendor",
      "name": "Product vendor"
    }
  ],
  "presets": [
    {
      "name": "Single product",
      "blocks": [
        {
          "type": "product_title"
        },
        {
          "type": "product_price"
        },
        {
          "type": "product_description"
        },
        {
          "type": "product_variant"
        },
        {
          "type": "product_add_to_cart"
        }
      ]
    }
  ]
}
{% endschema %}
